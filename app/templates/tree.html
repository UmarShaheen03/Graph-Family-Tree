{% extends "base.html" %}

{% block headBlock %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/tree.css') }}"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <title>Dehdashti Family Graph</title>
{% endblock %}

{% block bodyBlock %}
<div class="container-fluid">
    <div class="row">
        <!-- Modify Graph -->
        <div class="col-lg-3">
            <div class="card shadow-lg rounded-lg border-0 vh-100">
                <div class="card-body p-2">
                    <h5 class="text-center mb-2 mt-2">MODIFY GRAPH</h5>
                    <form action="" method="post" novalidate class="Form">
                        {{ form_modify.hidden_tag() }}
                        
                        <div class="form-group mb-4">
                            <label for="action" class="form-label fw-bold">{{ form_modify.action.label }}</label>
                            {{ form_modify.action(class="form-select form-select-lg") }}
                        </div>

                        <div id="name-group" class="form-group mb-4" style="display:none;">
                            <label for="name" class="form-label fw-bold">{{ form_modify.name.label }}</label>
                            {{ form_modify.name(class="form-control form-control-lg") }}
                        </div>

                        <div id="new-name-group" class="form-group mb-4" style="display:none;">
                            <label for="new_name" class="form-label fw-bold">{{ form_modify.new_name.label }}</label>
                            {{ form_modify.new_name(class="form-control form-control-lg") }}
                        </div>

                        <div id="old-name-group" class="form-group mb-4" style="display:none;">
                            <label for="old_name" class="form-label fw-bold">{{ form_modify.old_name.label }}</label>
                            {{ form_modify.old_name(class="form-select form-select-lg form-select-searchable") }}
                        </div>

                        <div id="person-to-shift-group" class="form-group mb-4" style="display:none;">
                            <label for="person_to_shift" class="form-label fw-bold">{{ form_modify.person_to_shift.label }}</label>
                            {{ form_modify.person_to_shift(class="form-select form-select-lg form-select-searchable") }}
                        </div>

                        <div id="person-to-delete-group" class="form-group mb-4" style="display:none;">
                            <label for="person_to_delete" class="form-label fw-bold">{{ form_modify.person_to_delete.label }}</label>
                            {{ form_modify.person_to_delete(class="form-select form-select-lg form-select-searchable") }}
                        </div>

                        <div id="parent-group" class="form-group mb-4">
                            <label for="parent" class="form-label fw-bold">{{ form_modify.parent.label }}</label>
                            {{ form_modify.parent(class="form-select form-select-lg form-select-searchable") }}
                        </div>

                        <div id="new-parent-group" class="form-group mb-4" style="display:none;">
                            <label for="new_parent" class="form-label fw-bold">{{ form_modify.new_parent.label }}</label>
                            {{ form_modify.new_parent(class="form-select form-select-lg form-select-searchable") }}
                        </div>

                        <div class="d-grid gap-2">
                            {{ form_modify.submit_modify(class="btn btn-primary btn-lg rounded-pill") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-9 vh-100 mt-2">
            <p></p>
            {{ form_search.hidden_tag() }}
            <div class="row align-items-center">
                <div class="col-auto">
                    {{ form_search.fullname(id="fullname", class="form-select-searchable w-100") }}
                </div>
                <div class="col-auto">
                    {{ form_search.submit_search(id="Search", class="btn btn-primary btn-lg rounded-pill") }}
                </div>
            </div>
            <div id="graph-container">                
                <svg id="graph"></svg>
            </div>
            <div id="tooltip"></div>
        </div>
    </div>
</div>

<!-- Custom Context Menu -->
<ul id="context-menu" class="custom-menu" style="display:none; position:absolute; z-index:1000;">
    <li onclick="modifyGraphAction('edit')">Edit Node</li>
    <li onclick="modifyGraphAction('delete')">Delete Node</li>
    <li onclick="modifyGraphAction('shift')">Shift Node</li>
    <li onclick="modifyGraphAction('add')">Add Child</li>
    <li onclick="goToBiography()">View Biography</li>
</ul>

<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
    var nodes = {{ nodes|tojson }};
    var links = {{ relationships|tojson }};
    var selectedNode = null;

    // Step 1: Build a lookup map of nodes
    var nodeMap = {};
    nodes.forEach(node => {
        nodeMap[node.name] = { ...node, children: [] };
    });

    // Step 2: Track added nodes to prevent duplicates
    var addedNodes = new Set();

    // Step 3: Build the hierarchy by linking child nodes to their parents
    links.forEach(link => {
        const parentNode = nodeMap[link.source];
        const childNode = nodeMap[link.target];

        // Step 4: Only add childNode if it hasn't been added yet
        if (parentNode && childNode && !addedNodes.has(childNode.name)) {
            parentNode.children.push(childNode);  // Link the child node to its parent
            addedNodes.add(childNode.name);  // Mark this node as added
        }
    });

    // Step 5: Detect root nodes (nodes that are not children of any other node)
    var roots = nodes.filter(node => 
        !links.some(link => link.target === node.name)
    ).map(rootNode => nodeMap[rootNode.name]);

    // If multiple roots exist, create a stand-in root and link all detected roots to it
    if (roots.length > 1) {
        var standInRoot = { name: "Stand-In Root", hierarchy: 0, lineage: 0, children: roots };
    } else {
        var standInRoot = roots[0];  // If only one root, use it directly
    }

    // const width = document.getElementById('graph-container').clientWidth;
    const height = document.getElementById('graph-container').clientHeight;
    const width = document.getElementById('graph-container');
    // const height = document.getElementById('graph-container');
    const cx = width * 0.5; // adjust as needed to fit
    const cy = height * 0.5; // adjust as needed to fit
    const radius = Math.min(width, height) / 2 - 30;

    // Setup zoom
    const zoom = d3.zoom()
        .scaleExtent([0.01, 4])
        .on("zoom", (event) => {
            svg.attr("transform", event.transform);
        });

    const svg = d3.select("#graph")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", [-cx, -cy, width, height])
        .attr("style", "width: 100%; height: auto; font: 10px sans-serif;")
        .call(zoom)
        .append("g")
        .attr("transform", `translate(${width / 2},${height / 2})`);  // Centering the radial layout

    const tree = d3.tree()
        .size([2 * Math.PI, radius])
        .separation((a, b) => (a.parent == b.parent ? 1 : 2) / a.depth);

    // Build the tree layout using the stratified hierarchy
    const root = tree(d3.hierarchy(standInRoot)
        .sort((a, b) => d3.ascending(a.data.name, b.data.name)));

    // Adjust the radius manually to increase distance between generations
    root.each(d => {
        d.y = d.depth * 100;  // Increase the multiplier (150) to add more space between generations
    });

    // Tooltip setup
    const tooltip = d3.select("#tooltip")
        .style("opacity", 0);  // Initially hidden

    // Color scale based on hierarchy levels
    const colorScale = d3.scaleOrdinal()
        .domain(d3.range(0, 10))  // Levels 0-9
        .range([
            '#3D0E61', 
            '#461177', 
            '#4E148C', 
            '#5829A7', 
            '#613DC1', 
            '#7364D2', 
            '#858AE3', 
            '#8EB5F0',
            '#93CAF6', 
            '#97DFFC'  
        ]);

    function modifyGraphAction(action) {
        const nodeName = selectedNode.name;

        // Auto-select the action in the form
        const actionField = document.querySelector('select[name="action"]');
        actionField.value = action;
        actionField.dispatchEvent(new Event('change')); // Trigger the form's change event to toggle fields

        // Auto-fill the relevant fields based on the selected action
        if (action === 'edit') {
            $('select[name="old_name"]').val(nodeName).trigger('change'); // Set value for Select2
            $('input[name="new_name"]').val(''); // Clear the new name field
        } else if (action === 'delete') {
            $('select[name="person_to_delete"]').val(nodeName).trigger('change'); // Set value for Select2
        } else if (action === 'shift') {
            $('select[name="person_to_shift"]').val(nodeName).trigger('change'); // Set value for Select2
            $('select[name="new_parent"]').val(null).trigger('change'); // Clear the new parent field in Select2
        } else if (action === 'add') {
            $('input[name="name"]').val(''); // Clear the name field
            $('select[name="parent"]').val(nodeName).trigger('change'); // Set value for Select2
        }

        // Trigger form updates to show/hide fields after filling the data
        actionField.dispatchEvent(new Event('change'));
        
        // Close the context menu
        document.getElementById('context-menu').style.display = 'none';
    }

    function goToBiography() {
        if (selectedNode) {
            window.location.href = "/biography/" + encodeURIComponent(selectedNode.name);  // Redirect to view bio page
            ;
        }
    }

    // Add links
    svg.append("g")
        .attr("fill", "none")
        .attr("stroke", "#555")
        .attr("stroke-opacity", 0.4)
        .attr("stroke-width", 1.5)
        .selectAll("path")
        .data(root.links().filter(link => link.source.data.name !== "Stand-In Root"))  // Filter out stand-in root links
        .join("path")
        .attr("d", d3.linkRadial()
            .angle(d => d.x)
            .radius(d => d.y));

    // Add nodes
    const node = svg.append("g")
        .selectAll("g")
        .data(root.descendants().filter(d => d.data.name !== "Stand-In Root"))  // Filter out stand-in root node
        .join("g")
        .attr("transform", d => `
            rotate(${d.x * 180 / Math.PI - 90}) 
            translate(${d.y},0)`);

    node.append("circle")
        .attr("fill", d => colorScale(d.depth % 10))  // Assign color based on hierarchy level
        .attr("r", 5)
        .on("mouseover", function (event, d) {
            tooltip.transition().duration(200).style("opacity", 0.9);
            tooltip.html(d.data.name)  // Display node name in tooltip
                .style("left", (event.pageX + 5) + "px")
                .style("top", (event.pageY - 28) + "px");

            highlightDirectLineage(d);  // Custom function for highlighting
        })
        .on("mouseout", function () {
            tooltip.transition().duration(500).style("opacity", 0);  // Hide tooltip
            unhighlightConnections();
        })
        .on("contextmenu", function(event, d) {
            event.preventDefault();
            selectedNode = d.data;

            // Show custom context menu
            const menu = document.getElementById('context-menu');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.style.display = 'block';

            menu.dataset.nodeName = d.data.name;
        });

    node.append("text")
        .attr("dy", "0.31em")
        .attr("x", d => d.x < Math.PI === !d.children ? 6 : -6)
        .attr("text-anchor", d => d.x < Math.PI === !d.children ? "start" : "end")
        .attr("transform", d => `rotate(${d.x >= Math.PI ? 180 : 0})`)
        .attr("paint-order", "stroke")
        .attr("stroke", "white")
        .attr("fill", "currentColor")
        .attr("stroke-linejoin", "round")
        .attr("stroke-width", 3)
        .text(d => d.data.name);

    // Function to highlight the direct lineage (ancestors and descendants)
    function highlightDirectLineage(d) {
        highlightAncestors(d);
        highlightDescendants(d);
    }

    // Function to highlight ancestors recursively
    function highlightAncestors(d) {
        if (d.parent) {
            highlightLink(d.parent, d);  // Highlight link between parent and current node
            highlightAncestors(d.parent);  // Recursively highlight ancestors
        }
    }

    // Function to highlight descendants recursively
    function highlightDescendants(d) {
        if (d.children) {
            d.children.forEach(child => {
                highlightLink(d, child);  // Highlight link between node and each child
                highlightDescendants(child);  // Recursively highlight descendants
            });
        }
    }

    // Highlight the link between two nodes
    function highlightLink(source, target) {
        svg.selectAll("path")
            .filter(link => link.source.data.name === source.data.name && link.target.data.name === target.data.name)
            .classed("highlighted", true);

        svg.selectAll("circle")
            .filter(n => n.data.name === source.data.name || n.data.name === target.data.name)
            .attr("fill", "#ff5722");  // Change color of highlighted nodes
    }

    // Unhighlight all connections
    function unhighlightConnections() {
        svg.selectAll("path").classed("highlighted", false);
        svg.selectAll("circle").attr("fill", d => colorScale(d.depth % 10));  // Reset to original colors
    }

    document.addEventListener('click', function () {
        document.getElementById('context-menu').style.display = 'none';
    });
</script>

<!-- Modify graph script -->
<script src="{{ url_for('static', filename='js/modify_graph.js') }}"></script>

{% endblock %}
