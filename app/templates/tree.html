<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree </title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            overflow: hidden;
        }
        #graph-container {
            width: 80vw;
            height: 80vh;
            border: 1px solid #ccc;
            overflow: hidden;
        }
        svg {
            width: 100%;
            height: 100%;
        }
        .node {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 2px;
        }
        .link {
            stroke: #555;
            stroke-width: 2px;
            stroke-opacity: 0.8;
        }
        #tooltip {
            position: absolute;
            text-align: center;
            padding: 4px;
            font-size: 12px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div id="graph-container">
        <svg id="graph"></svg>
    </div>
    <div id="tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        var nodes = {{ nodes|tojson }};
        var links = {{ relationships|tojson }};
        
        const width = document.getElementById('graph-container').clientWidth;
        const height = document.getElementById('graph-container').clientHeight;
        const centerX = width / 2;
        const centerY = height / 2;

        // Setup zoom
        const zoom = d3.zoom()
            .scaleExtent([0.01, 4])
            .on("zoom", (event) => {
                svg.attr("transform", event.transform);
            });
    
        const svg = d3.select("#graph")
            .attr("width", width)
            .attr("height", height)
            .call(zoom)
            .append("g");
    
        // Tooltip setup
        const tooltip = d3.select("#tooltip")
            .style("opacity", 0);  // Initially hidden
    
        
    
        // Group nodes by hierarchy level
        function groupNodesByHierarchy(nodes) {
            return d3.group(nodes, d => d.hierarchy);
        }
    
        // Calculate dynamic radius for each hierarchy based on node count
        function calculateDynamicRadius(hierarchy, totalHierarchies, nodeCount) {
            // A basic formula to increase radius dynamically based on hierarchy and node count
            const baseRadius = 150;  // Minimum radius
            return baseRadius + (hierarchy * 50) + (nodeCount * 2);  // Increase radius slightly with node count
        }
    
        // Circular layout with parent-child alignment
        function visualizeGraph(nodes, links) {
            const groupedNodes = groupNodesByHierarchy(nodes);
    
            // Place nodes in a relaxed circular fashion by hierarchy
            groupedNodes.forEach((group, hierarchy) => {
                const nodeCount = group.length;
                const angleStep = (2 * Math.PI) / nodeCount;
                const radius = calculateDynamicRadius(hierarchy, groupedNodes.size, nodeCount);
    
                group.forEach((node, i) => {
                    const angle = i * angleStep;
                    node.x = centerX + Math.cos(angle) * radius;
                    node.y = centerY + Math.sin(angle) * radius;
                    node.angle = angle;
                });
            });
    
            // Filter out links where the source and target are in the same hierarchy
            const validLinks = links.filter(link => {
                const sourceNode = nodes.find(node => node.name === link.source);
                const targetNode = nodes.find(node => node.name === link.target);
                return sourceNode.hierarchy !== targetNode.hierarchy;
            });
    
            // Draw links between nodes
            svg.selectAll(".link")
                .data(validLinks)
                .enter().append("line")
                .attr("class", "link")
                .attr("x1", d => nodes.find(node => node.name === d.source).x)
                .attr("y1", d => nodes.find(node => node.name === d.source).y)
                .attr("x2", d => nodes.find(node => node.name === d.target).x)
                .attr("y2", d => nodes.find(node => node.name === d.target).y)
                .attr("stroke", "#ccc");
    
            // Draw nodes with drag behavior
            const nodeElements = svg.selectAll(".node")
                .data(nodes)
                .enter().append("g")
                .attr("class", "node")
                .on("mouseover", function (event, d) {
                    tooltip.transition().duration(200).style("opacity", 0.9);
                    tooltip.html(d.name)  // Display node name in tooltip
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function () {
                    tooltip.transition().duration(500).style("opacity", 0);  // Hide tooltip
                })
                .call(d3.drag() 
                    .on("start", function (event, d) {
                        d3.select(this).raise().classed("active", true);
                    })
                    .on("drag", function (event, d) {
                        d.x = event.x;
                        d.y = event.y;
                        d3.select(this).select("circle").attr("cx", d.x).attr("cy", d.y);
                        d3.select(this).select("text").attr("x", d.x + 10).attr("y", d.y);
                        svg.selectAll(".link")
                            .filter(link => link.source === d.name || link.target === d.name)
                            .attr("x1", link => nodes.find(node => node.name === link.source).x)
                            .attr("y1", link => nodes.find(node => node.name === link.source).y)
                            .attr("x2", link => nodes.find(node => node.name === link.target).x)
                            .attr("y2", link => nodes.find(node => node.name === link.target).y);
                    })
                    .on("end", function (event, d) {
                        d3.select(this).classed("active", false);
                    })
                );
    
            // Add circle for each node
            nodeElements.append("circle")
                .attr("r", 15)
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("fill", d => color(d.hierarchy));
    
            // Add text label for each node showing the hierarchy number
            nodeElements.append("text")
                .attr("x", d => d.x + 10)
                .attr("y", d => d.y)
                .text(d => "H" + d.hierarchy)
                .attr("font-size", "12px")
                .attr("fill", "#000");
        }
    
        visualizeGraph(nodes, links);
    </script>
    
</body>
</html>





